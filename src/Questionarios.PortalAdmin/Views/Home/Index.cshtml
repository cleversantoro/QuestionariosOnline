@using System.Text.Json
@model Questionarios.PortalAdmin.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var chartJson = Model.ChartData is null ? "null" : JsonSerializer.Serialize(Model.ChartData);
}
<div class="page-header">
    <div>
        <p class="eyebrow">Ola, @Model.UserName</p>
        <h1>Dashboard</h1>
        <p class="text-muted">Escolha um questionario e acompanhe os indicadores em tempo real.</p>
    </div>
    <div class="header-actions">
        <div class="form-group mb-0">
            <label class="form-label">Questionario</label>
            <select id="surveySelect" class="form-select">
                @foreach (var item in Model.Surveys)
                {
                    <option value="@item.Id" selected="@(item.Id == Model.SelectedSurveyId)">@item.Title</option>
                }
            </select>
        </div>
        <a class="btn btn-primary btn-lg" asp-controller="Home" asp-action="Index" asp-fragment="cadastro-questionario">
            <i class="bi bi-plus-lg me-2"></i>Novo Questionario
        </a>
    </div>
</div>

@if (!Model.Surveys.Any())
{
    <div class="alert alert-warning">Nenhum questionario encontrado na API.</div>
}

<section class="highlight-grid">
    @foreach (var card in Model.Highlights)
    {
        <article class="stat-card">
            <div class="stat-card__label">@card.Title</div>
            <div class="stat-card__value">@card.Value</div>
            <div class="stat-card__trend @(card.TrendIsPositive ? "text-success" : "text-danger")">
                <i class="bi @(card.TrendIsPositive ? "bi-arrow-up-right" : "bi-arrow-down-right") me-1"></i>
                @card.Trend
            </div>
        </article>
    }
</section>

<section class="charts-grid" id="charts">
    <article class="panel-card wide">
        <div class="panel-card__head">
            <div>
                <p class="eyebrow">Panorama</p>
                <h3>Respostas por opcao</h3>
            </div>
            <div class="chip chip-success">API</div>
        </div>
        <canvas id="responsesChart" height="140"></canvas>
    </article>
    <article class="panel-card">
        <div class="panel-card__head">
            <div>
                <p class="eyebrow">Distribuicao</p>
                <h3>Por pergunta</h3>
            </div>
        </div>
        <canvas id="distributionChart" height="220"></canvas>
    </article>
    <article class="panel-card">
        <div class="panel-card__head">
            <div>
                <p class="eyebrow">Comparativo</p>
                <h3>Opcoes em barras</h3>
            </div>
        </div>
        <canvas id="channelChart" height="220"></canvas>
    </article>
</section>

@section Scripts {
    <script>
        const apiBaseUrl = "@Model.ApiBaseUrl".replace(/\/$/, "");
        const initialChart = @Html.Raw(chartJson);

        const surveySelect = document.getElementById("surveySelect");
        const responseCtx = document.getElementById("responsesChart");
        const distributionCtx = document.getElementById("distributionChart");
        const channelCtx = document.getElementById("channelChart");

        const responsesChart = new Chart(responseCtx, {
            type: "line",
            data: { labels: [], datasets: [{ label: "Respostas", data: [], fill: true, tension: 0.4, borderColor: "#5c7bff", backgroundColor: "rgba(92, 123, 255, 0.15)", pointRadius: 4 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        const distributionChart = new Chart(distributionCtx, {
            type: "doughnut",
            data: { labels: [], datasets: [{ data: [], backgroundColor: ["#4ade80", "#60a5fa", "#f97316", "#c084fc"], borderWidth: 0 }] },
            options: { plugins: { legend: { position: "bottom" } } }
        });

        const channelChart = new Chart(channelCtx, {
            type: "bar",
            data: { labels: [], datasets: [{ data: [], backgroundColor: ["#5c7bff", "#22d3ee", "#f97316"], borderRadius: 8 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        function renderCharts(chartData) {
            if (!chartData || !chartData.Questions || chartData.Questions.length === 0) {
                return;
            }
            const firstQuestion = chartData.Questions[0];
            const secondQuestion = chartData.Questions[1] || firstQuestion;

            const lineLabels = firstQuestion.Options.map(o => o.Label);
            const lineValues = firstQuestion.Options.map(o => o.Votes);
            responsesChart.data.labels = lineLabels;
            responsesChart.data.datasets[0].data = lineValues;
            responsesChart.update();

            distributionChart.data.labels = firstQuestion.Options.map(o => o.Label);
            distributionChart.data.datasets[0].data = firstQuestion.Options.map(o => o.Votes);
            distributionChart.update();

            channelChart.data.labels = secondQuestion.Options.map(o => o.Label);
            channelChart.data.datasets[0].data = secondQuestion.Options.map(o => o.Votes);
            channelChart.update();
        }

        async function loadSurveyChart(surveyId) {
            if (!surveyId) return;
            try {
                const response = await fetch(`${apiBaseUrl}/api/results/${surveyId}/chart`);
                if (!response.ok) return;
                const data = await response.json();
                renderCharts(data);
            } catch (err) {
                console.error("Erro ao buscar grafico", err);
            }
        }

        surveySelect?.addEventListener("change", (event) => {
            loadSurveyChart(event.target.value);
        });

        renderCharts(initialChart);
    </script>
}
